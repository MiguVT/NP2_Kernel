# =============================================================================
# Nothing Phone 2 Kernel Build Workflow
# =============================================================================
# Production-grade, maintainable workflow for building kernel with
# Wild_KSU and SUSFS4KSU integration.
#
# Key Features:
#   - All configuration centralized in env block (no scattered values)
#   - Modular enable/disable for KSU and SUSFS via inputs
#   - Comprehensive error handling and validation
#   - Clean artifact naming with version information
#   - Detailed build summary with all component versions
#
# Sources:
#   - Kernel: https://github.com/MiguVT/kernel_nothing_sm8475_cleaned
#   - Wild_KSU: https://github.com/WildKernels/Wild_KSU (wild-susfs branch)
#   - SUSFS: https://gitlab.com/simonpunk/susfs4ksu (v2.0.0+)
#
# Note: Even when using wild-susfs branch, manual SUSFS kernel patches are
# still required. The setup script integrates the KSU component, NOT the
# kernel modifications.
#
# Last Updated: January 2026
# =============================================================================

name: Build Nothing Phone 2 Kernel

on:
  workflow_dispatch:
    inputs:
      kernel_branch:
        description: 'Kernel source branch'
        required: false
        type: string
        default: 'clean'
      os_patch_level:
        description: 'Security patch level (YYYY-MM format)'
        required: false
        type: string
        default: '2025-12'
      ksu_version:
        description: 'Wild_KSU version (tag/commit, empty for latest)'
        required: false
        type: string
        default: ''
      enable_kernelsu:
        description: 'Enable Wild_KSU integration'
        required: false
        type: boolean
        default: true
      enable_susfs:
        description: 'Enable SUSFS root hiding (requires KernelSU)'
        required: false
        type: boolean
        default: true
      build_type:
        description: 'Build type (affects optimizations)'
        required: false
        type: choice
        options:
          - release
          - debug
        default: 'release'

  workflow_call:
    inputs:
      kernel_branch:
        required: false
        type: string
        default: 'clean'
      os_patch_level:
        required: false
        type: string
        default: '2025-12'
      ksu_version:
        required: false
        type: string
        default: ''
      enable_kernelsu:
        required: false
        type: boolean
        default: true
      enable_susfs:
        required: false
        type: boolean
        default: true
      build_type:
        required: false
        type: string
        default: 'release'

permissions:
  contents: write
  actions: write

# =============================================================================
# CONFIGURATION BLOCK
# =============================================================================
# All configurable values are centralized here. Modify these to customize
# the build without touching the workflow logic below.
# =============================================================================
env:
  # ---------------------------------------------------------------------------
  # Kernel Source Configuration
  # ---------------------------------------------------------------------------
  KERNEL_REPO: 'https://github.com/MiguVT/kernel_nothing_sm8475_cleaned.git'
  KERNEL_DEFCONFIG: 'vendor/meteoric_defconfig'
  
  # ---------------------------------------------------------------------------
  # Target Device Information
  # ---------------------------------------------------------------------------
  DEVICE_NAME: 'NothingPhone2'
  DEVICE_CODENAME: 'Pong'
  DEVICE_PLATFORM: 'SM8475'
  
  # ---------------------------------------------------------------------------
  # Android/GKI Version (determines SUSFS branch and GKI boot images)
  # ---------------------------------------------------------------------------
  ANDROID_VERSION: '12'
  KERNEL_VERSION: '5.10'
  
  # ---------------------------------------------------------------------------
  # Wild_KSU Configuration (based on wild-susfs branch)
  # ---------------------------------------------------------------------------
  # Note: wild-susfs branch has SUSFS base integration but kernel patches
  # still need to be applied manually from the SUSFS repository
  WILD_KSU_SETUP_URL: 'https://raw.githubusercontent.com/WildKernels/Wild_KSU/wild/kernel/setup.sh'
  WILD_KSU_REPO_URL: 'https://github.com/WildKernels/Wild_KSU'
  WILD_KSU_BRANCH: 'wild-susfs'
  
  # ---------------------------------------------------------------------------
  # SUSFS Configuration
  # ---------------------------------------------------------------------------
  SUSFS_REPO: 'https://gitlab.com/simonpunk/susfs4ksu.git'
  SUSFS_BRANCH: 'gki-android12-5.10'
  SUSFS_KERNEL_PATCH: '50_add_susfs_in_gki-android12-5.10.patch'
  SUSFS_KSU_PATCH: '10_enable_susfs_for_ksu.patch'
  
  # ---------------------------------------------------------------------------
  # Build Configuration
  # ---------------------------------------------------------------------------
  ARCH: 'arm64'
  CROSS_COMPILE: 'aarch64-linux-gnu-'
  
  # ---------------------------------------------------------------------------
  # AOSP Tools Configuration
  # ---------------------------------------------------------------------------
  AOSP_BRANCH: 'main-kernel-2025'
  AOSP_MIRROR: 'https://android.googlesource.com'
  
  # ---------------------------------------------------------------------------
  # AnyKernel3 Configuration
  # ---------------------------------------------------------------------------
  ANYKERNEL_REPO: 'https://github.com/osm0sis/AnyKernel3.git'

jobs:
  build:
    name: Build Kernel
    runs-on: ubuntu-latest
    timeout-minutes: 120

    steps:
      # ========================================================================
      # PHASE 0: BUILD CACHE
      # ========================================================================
      
      - name: Setup Build Cache
        uses: actions/cache@v4
        with:
          path: |
            ~/.ccache
            kernel-build-cache
          key: kernel-build-${{ env.KERNEL_VERSION }}-${{ inputs.kernel_branch || 'clean' }}-${{ github.sha }}
          restore-keys: |
            kernel-build-${{ env.KERNEL_VERSION }}-${{ inputs.kernel_branch || 'clean' }}-
            kernel-build-${{ env.KERNEL_VERSION }}-

      # ========================================================================
      # PHASE 1: ENVIRONMENT SETUP
      # ========================================================================
      
      - name: Initialize Build Environment
        id: init
        run: |
          echo "::group::Build Information"
          echo "ðŸ“¦ Device: ${{ env.DEVICE_NAME }} (${{ env.DEVICE_CODENAME }})"
          echo "ðŸ”§ Platform: ${{ env.DEVICE_PLATFORM }}"
          echo "ðŸ“± Android Version: ${{ env.ANDROID_VERSION }}"
          echo "ðŸ§ Kernel Version: ${{ env.KERNEL_VERSION }}"
          echo "ðŸŒ¿ Kernel Branch: ${{ inputs.kernel_branch || 'clean' }}"
          echo "ðŸ” Security Patch: ${{ inputs.os_patch_level || '2025-12' }}"
          echo "ðŸ”‘ KernelSU: ${{ inputs.enable_kernelsu && 'Enabled' || 'Disabled' }}"
          echo "ðŸ›¡ï¸ SUSFS: ${{ inputs.enable_susfs && 'Enabled' || 'Disabled' }}"
          echo "âš™ï¸ Build Type: ${{ inputs.build_type || 'release' }}"
          echo "::endgroup::"
          
          # Set computed variables
          echo "KERNEL_BRANCH=${{ inputs.kernel_branch || 'clean' }}" >> "$GITHUB_ENV"
          echo "OS_PATCH_LEVEL=${{ inputs.os_patch_level || '2025-12' }}" >> "$GITHUB_ENV"
          echo "ENABLE_KSU=${{ inputs.enable_kernelsu }}" >> "$GITHUB_ENV"
          echo "ENABLE_SUSFS=${{ inputs.enable_susfs }}" >> "$GITHUB_ENV"
          echo "BUILD_TYPE=${{ inputs.build_type || 'release' }}" >> "$GITHUB_ENV"
          echo "BUILD_DATE=$(date -u +%Y%m%d)" >> "$GITHUB_ENV"
          echo "BUILD_TIMESTAMP=$(date -u +%Y-%m-%dT%H:%M:%SZ)" >> "$GITHUB_ENV"

      - name: Maximize Build Space
        run: |
          echo "::group::Initial Disk Space"
          df -BG / | tail -1
          echo "::endgroup::"
          
          echo "::group::Cleaning System"
          # Remove unnecessary packages to free space
          sudo rm -rf \
            /usr/share/dotnet \
            /usr/local/lib/android \
            /opt/ghc \
            /opt/hostedtoolcache \
            /usr/local/share/boost \
            "$AGENT_TOOLSDIRECTORY" 2>/dev/null || true
          
          sudo apt-get clean
          sudo apt-get autoremove -y
          echo "::endgroup::"
          
          echo "::group::Available Disk Space"
          df -BG / | tail -1
          echo "::endgroup::"

      - name: Install Build Dependencies
        run: |
          echo "::group::Installing Packages"
          sudo apt-get update
          sudo apt-get install -y --no-install-recommends \
            build-essential \
            bc \
            bison \
            flex \
            libelf-dev \
            libssl-dev \
            cpio \
            zip \
            unzip \
            python3 \
            clang \
            llvm \
            lld \
            gcc-aarch64-linux-gnu \
            ccache
          echo "::endgroup::"
          
          # Configure ccache
          mkdir -p ~/.ccache
          echo "max_size = 5G" > ~/.ccache/ccache.conf
          echo "compression = true" >> ~/.ccache/ccache.conf
          
          echo "::group::Toolchain Versions"
          echo "Clang: $(clang --version | head -1)"
          echo "LLD: $(ld.lld --version | head -1)"
          echo "GCC: $(aarch64-linux-gnu-gcc --version | head -1)"
          echo "::endgroup::"

      - name: Setup AOSP Build Tools
        run: |
          echo "::group::Cloning AOSP Tools"
          # Clone in parallel for speed
          git clone --depth=1 -b "${{ env.AOSP_BRANCH }}" \
            "${{ env.AOSP_MIRROR }}/kernel/prebuilts/build-tools" \
            "$GITHUB_WORKSPACE/build-tools" &
          PID1=$!
          
          git clone --depth=1 -b "${{ env.AOSP_BRANCH }}" \
            "${{ env.AOSP_MIRROR }}/platform/system/tools/mkbootimg" \
            "$GITHUB_WORKSPACE/mkbootimg" &
          PID2=$!
          
          # Wait for both and check for errors
          wait $PID1 || { echo "âŒ Failed to clone build-tools"; exit 1; }
          wait $PID2 || { echo "âŒ Failed to clone mkbootimg"; exit 1; }
          echo "::endgroup::"
          
          # Export paths
          {
            echo "AVBTOOL=$GITHUB_WORKSPACE/build-tools/linux-x86/bin/avbtool"
            echo "MKBOOTIMG=$GITHUB_WORKSPACE/mkbootimg/mkbootimg.py"
            echo "UNPACK_BOOTIMG=$GITHUB_WORKSPACE/mkbootimg/unpack_bootimg.py"
            echo "BOOT_SIGN_KEY=$GITHUB_WORKSPACE/build-tools/linux-x86/share/avb/testkey_rsa2048.pem"
          } >> "$GITHUB_ENV"
          
          echo "$GITHUB_WORKSPACE/build-tools/linux-x86/bin" >> "$GITHUB_PATH"
          
          echo "âœ… AOSP build tools ready"

      - name: Setup Custom Signing Key
        env:
          CUSTOM_SIGN_KEY: ${{ secrets.BOOT_SIGN_KEY }}
        if: env.CUSTOM_SIGN_KEY != ''
        run: |
          echo "$CUSTOM_SIGN_KEY" > "$GITHUB_WORKSPACE/build-tools/linux-x86/share/avb/testkey_rsa2048.pem"
          echo "âœ… Using custom boot signing key"

      # ========================================================================
      # PHASE 2: CLONE SOURCES
      # ========================================================================

      - name: Clone Kernel Source
        run: |
          echo "::group::Cloning Kernel"
          git clone --depth=1 -b "${{ env.KERNEL_BRANCH }}" \
            "${{ env.KERNEL_REPO }}" \
            "$GITHUB_WORKSPACE/kernel"
          echo "::endgroup::"
          
          # Extract kernel version info
          cd "$GITHUB_WORKSPACE/kernel"
          VERSION=$(sed -n 's/^VERSION = //p' Makefile)
          PATCHLEVEL=$(sed -n 's/^PATCHLEVEL = //p' Makefile)
          SUBLEVEL=$(sed -n 's/^SUBLEVEL = //p' Makefile)
          
          KERNEL_FULL_VERSION="${VERSION}.${PATCHLEVEL}.${SUBLEVEL}"
          echo "KERNEL_FULL_VERSION=$KERNEL_FULL_VERSION" >> "$GITHUB_ENV"
          echo "KERNEL_SUBLEVEL=$SUBLEVEL" >> "$GITHUB_ENV"
          
          echo "âœ… Kernel source cloned: v$KERNEL_FULL_VERSION (branch: ${{ env.KERNEL_BRANCH }})"

      - name: Validate Kernel Defconfig Exists
        run: |
          KERNEL_DIR="$GITHUB_WORKSPACE/kernel"
          DEFCONFIG_PATH="$KERNEL_DIR/arch/${{ env.ARCH }}/configs/${{ env.KERNEL_DEFCONFIG }}"
          
          echo "::group::Checking Defconfig"
          echo "Looking for: $DEFCONFIG_PATH"
          
          if [ -f "$DEFCONFIG_PATH" ]; then
            echo "âœ… Defconfig found: ${{ env.KERNEL_DEFCONFIG }}"
            echo "File size: $(stat -c%s "$DEFCONFIG_PATH") bytes"
          else
            echo "âŒ Defconfig NOT FOUND: ${{ env.KERNEL_DEFCONFIG }}"
            echo ""
            echo "Available defconfigs in arch/${{ env.ARCH }}/configs/vendor/:"
            ls -la "$KERNEL_DIR/arch/${{ env.ARCH }}/configs/vendor/" | grep defconfig || echo "No defconfigs found!"
            echo "Available defconfigs in arch/${{ env.ARCH }}/configs/:"
            ls -la "$KERNEL_DIR/arch/${{ env.ARCH }}/configs/" | grep defconfig || echo "No defconfigs found!"
            exit 1
          fi
          echo "::endgroup::"

      - name: Setup Wild_KSU
        if: inputs.enable_kernelsu != false
        run: |
          cd "$GITHUB_WORKSPACE/kernel"
          
          echo "::group::Running Wild_KSU Setup"
          # Use wild-susfs branch which has SUSFS base integration
          # Note: This integrates the KSU component, but kernel patches still need manual application
          KSU_ARG="${{ inputs.ksu_version }}"
          if [ -n "$KSU_ARG" ]; then
            echo "Installing Wild_KSU version: $KSU_ARG"
            curl -LSs "${{ env.WILD_KSU_SETUP_URL }}" | bash -s "$KSU_ARG"
          else
            echo "Installing Wild_KSU with wild-susfs branch"
            curl -LSs "${{ env.WILD_KSU_SETUP_URL }}" | bash -s wild-susfs
          fi
          echo "::endgroup::"
          
          # Robust KSU directory detection - check all possible locations
          KSU_DIR=""
          if [ -d "Wild_KSU" ]; then
            KSU_DIR="Wild_KSU"
            echo "âœ… Found Wild_KSU directory structure"
          elif [ -d "KernelSU" ]; then
            KSU_DIR="KernelSU"
            echo "âœ… Found KernelSU directory structure"
          elif [ -d "drivers/kernelsu" ]; then
            KSU_DIR="drivers/kernelsu"
            echo "âœ… Found integrated KernelSU structure (drivers/kernelsu)"
          else
            echo "âŒ KSU directory not found after setup"
            echo "::group::Debug: Directory contents"
            find . -maxdepth 2 -type d -name "*kernel*" -o -name "*ksu*" -o -name "*wild*" 2>/dev/null | head -20
            echo "::endgroup::"
            exit 1
          fi
          
          # Extract version information
          cd "$GITHUB_WORKSPACE/kernel"
          if [ -d "$KSU_DIR/.git" ]; then
            cd "$KSU_DIR"
            KSU_VERSION=$(git describe --tags --always 2>/dev/null || echo "unknown")
            KSU_COMMIT=$(git rev-parse --short HEAD 2>/dev/null || echo "unknown")
            cd "$GITHUB_WORKSPACE/kernel"
          else
            KSU_VERSION="unknown"
            KSU_COMMIT="unknown"
          fi
          
          echo "KSU_DIR=$KSU_DIR" >> "$GITHUB_ENV"
          echo "KSU_VERSION=$KSU_VERSION" >> "$GITHUB_ENV"
          echo "KSU_COMMIT=$KSU_COMMIT" >> "$GITHUB_ENV"
          echo "âœ… Wild_KSU: $KSU_VERSION ($KSU_COMMIT) at $KSU_DIR"
          
          # Validate integration
          cd "$GITHUB_WORKSPACE/kernel"
          if grep -q "KernelSU\|Wild_KSU" Makefile 2>/dev/null || [ -f "drivers/kernelsu/Makefile" ] || [ -f "$KSU_DIR/kernel/Makefile" ]; then
            echo "âœ… Wild_KSU integration verified"
          else
            echo "âš ï¸ Wild_KSU integration could not be verified in Makefile"
          fi

      - name: Clone SUSFS
        if: inputs.enable_kernelsu != false && inputs.enable_susfs != false
        run: |
          echo "::group::Cloning SUSFS"
          git clone --depth=1 -b "${{ env.SUSFS_BRANCH }}" \
            "${{ env.SUSFS_REPO }}" \
            "$GITHUB_WORKSPACE/susfs"
          echo "::endgroup::"
          
          cd "$GITHUB_WORKSPACE/susfs"
          
          # Multi-source version detection for SUSFS
          SUSFS_VERSION=""
          
          # Try: Check version file first
          if [ -f "version.txt" ]; then
            SUSFS_VERSION=$(cat version.txt | tr -d '[:space:]')
          fi
          
          # Try: Get from git tags if available
          if [ -z "$SUSFS_VERSION" ]; then
            if git describe --tags 2>/dev/null | grep -qE 'v[0-9]+\.[0-9]+'; then
              SUSFS_VERSION=$(git describe --tags --abbrev=0 2>/dev/null)
            fi
          fi
          
          # Try: Extract from branch name
          if [ -z "$SUSFS_VERSION" ]; then
            BRANCH_VERSION=$(git rev-parse --abbrev-ref HEAD | grep -oE 'v[0-9]+\.[0-9]+' || echo "")
            if [ -n "$BRANCH_VERSION" ]; then
              SUSFS_VERSION="$BRANCH_VERSION"
            fi
          fi
          
          # Fallback: Use branch name + commit hash
          if [ -z "$SUSFS_VERSION" ]; then
            SUSFS_BRANCH=$(git rev-parse --abbrev-ref HEAD)
            SUSFS_VERSION="${SUSFS_BRANCH}-$(git rev-parse --short HEAD)"
          fi
          
          SUSFS_COMMIT=$(git rev-parse --short HEAD 2>/dev/null || echo "unknown")
          
          echo "SUSFS_COMMIT=$SUSFS_COMMIT" >> "$GITHUB_ENV"
          echo "SUSFS_VERSION=$SUSFS_VERSION" >> "$GITHUB_ENV"
          
          echo "âœ… SUSFS cloned: $SUSFS_VERSION ($SUSFS_COMMIT)"

      - name: Clone AnyKernel3
        run: |
          git clone --depth=1 "${{ env.ANYKERNEL_REPO }}" "$GITHUB_WORKSPACE/AnyKernel3"
          rm -rf "$GITHUB_WORKSPACE/AnyKernel3/.git"
          echo "âœ… AnyKernel3 cloned"

      # ========================================================================
      # PHASE 3: APPLY PATCHES
      # ========================================================================

      - name: Apply SUSFS Patches
        if: inputs.enable_kernelsu != false && inputs.enable_susfs != false
        run: |
          KERNEL_DIR="$GITHUB_WORKSPACE/kernel"
          SUSFS_DIR="$GITHUB_WORKSPACE/susfs"
          KSU_DIR="$GITHUB_WORKSPACE/kernel/${{ env.KSU_DIR }}"
          
          echo "::group::Copying SUSFS Source Files"
          # Copy SUSFS source files to kernel
          cp -v "$SUSFS_DIR/kernel_patches/fs/susfs.c" "$KERNEL_DIR/fs/"
          cp -v "$SUSFS_DIR/kernel_patches/include/linux/susfs.h" "$KERNEL_DIR/include/linux/"
          echo "::endgroup::"
          
          echo "::group::Applying Kernel SUSFS Patch"
          cd "$KERNEL_DIR"
          KERNEL_PATCH="$SUSFS_DIR/kernel_patches/${{ env.SUSFS_KERNEL_PATCH }}"
          
          if [ -f "$KERNEL_PATCH" ]; then
            if patch -p1 --dry-run --forward < "$KERNEL_PATCH" >/dev/null 2>&1; then
              patch -p1 --forward --no-backup-if-mismatch < "$KERNEL_PATCH"
              echo "âœ… Kernel SUSFS patch applied successfully"
            else
              echo "âš ï¸ Kernel patch may have conflicts, applying with --force"
              patch -p1 --forward --no-backup-if-mismatch -F 3 < "$KERNEL_PATCH" || true
            fi
          else
            echo "âŒ Kernel patch not found: $KERNEL_PATCH"
            exit 1
          fi
          echo "::endgroup::"
          
          echo "::group::Applying KernelSU SUSFS Patch"
          cd "$KSU_DIR"
          KSU_PATCH="$SUSFS_DIR/kernel_patches/KernelSU/${{ env.SUSFS_KSU_PATCH }}"
          
          if [ -f "$KSU_PATCH" ]; then
            if patch -p1 --dry-run --forward < "$KSU_PATCH" >/dev/null 2>&1; then
              patch -p1 --forward --no-backup-if-mismatch < "$KSU_PATCH"
              echo "âœ… KernelSU SUSFS patch applied successfully"
            else
              echo "âš ï¸ KernelSU patch may have conflicts, applying with --force"
              patch -p1 --forward --no-backup-if-mismatch -F 3 < "$KSU_PATCH" || true
            fi
          else
            echo "âŒ KernelSU patch not found: $KSU_PATCH"
            exit 1
          fi
          echo "::endgroup::"

      - name: Collect Patch Rejects
        if: always()
        run: |
          mkdir -p "$GITHUB_WORKSPACE/patch-rejects"
          
          REJ_COUNT=0
          while IFS= read -r -d '' rej; do
            rel_path="${rej#$GITHUB_WORKSPACE/kernel/}"
            dest_dir="$GITHUB_WORKSPACE/patch-rejects/$(dirname "$rel_path")"
            mkdir -p "$dest_dir"
            cp "$rej" "$dest_dir/"
            
            # Copy original file for context
            orig="${rej%.rej}"
            [ -f "$orig" ] && cp "$orig" "$dest_dir/"
            
            REJ_COUNT=$((REJ_COUNT + 1))
            echo "âš ï¸ Reject: $rel_path"
          done < <(find "$GITHUB_WORKSPACE/kernel" -name "*.rej" -type f -print0 2>/dev/null)
          
          echo "REJ_COUNT=$REJ_COUNT" >> "$GITHUB_ENV"
          
          if [ "$REJ_COUNT" -gt 0 ]; then
            echo "::warning::Found $REJ_COUNT patch reject(s) - manual fixes may be needed"
          else
            echo "âœ… No patch rejects found"
          fi

      # ========================================================================
      # PHASE 4: CONFIGURE KERNEL
      # ========================================================================

      - name: Configure Kernel
        run: |
          DEFCONFIG="$GITHUB_WORKSPACE/kernel/arch/${{ env.ARCH }}/configs/${{ env.KERNEL_DEFCONFIG }}"
          
          echo "::group::Kernel Configuration"
          echo "Defconfig: $DEFCONFIG"
          
          # Ensure defconfig exists
          if [ ! -f "$DEFCONFIG" ]; then
            echo "âŒ Defconfig not found: $DEFCONFIG"
            exit 1
          fi
          
          # Add configuration based on enabled features
          {
            echo ""
            echo "# ============================================="
            echo "# Auto-generated configuration - $(date -u +%Y-%m-%d)"
            echo "# ============================================="
          } >> "$DEFCONFIG"
          
          # KernelSU Configuration
          if [ "${{ inputs.enable_kernelsu }}" != "false" ]; then
            {
              echo ""
              echo "# KernelSU Configuration"
              echo "CONFIG_KSU=y"
            } >> "$DEFCONFIG"
          fi
          
          # SUSFS Configuration - corrected options for gki-android12-5.10 branch
          if [ "${{ inputs.enable_kernelsu }}" != "false" ] && [ "${{ inputs.enable_susfs }}" != "false" ]; then
            {
              echo ""
              echo "# SUSFS Configuration (v2.0.0+ for gki-android12-5.10)"
              echo "CONFIG_KSU_SUSFS=y"
              echo "CONFIG_KSU_SUSFS_SUS_PATH=y"
              echo "CONFIG_KSU_SUSFS_SUS_MOUNT=y"
              echo "CONFIG_KSU_SUSFS_TRY_UMOUNT=y"
              echo "CONFIG_KSU_SUSFS_SUS_KSTAT=y"
              echo "CONFIG_KSU_SUSFS_SPOOF_UNAME=y"
              echo "CONFIG_KSU_SUSFS_ENABLE_LOG=y"
              # NOTE: Removed deprecated options not in v2.0.0+ for this branch:
              # - CONFIG_KSU_SUSFS_AUTO_ADD_SUS_KSU_DEFAULT_MOUNT
              # - CONFIG_KSU_SUSFS_AUTO_ADD_SUS_BIND_MOUNT
              # - CONFIG_KSU_SUSFS_AUTO_ADD_TRY_UMOUNT_FOR_BIND_MOUNT
              # - CONFIG_KSU_SUSFS_SUS_OVERLAYFS
              # - CONFIG_KSU_SUSFS_OPEN_REDIRECT
            } >> "$DEFCONFIG"
          fi
          
          # Networking Configuration (OPTIONAL - not required for KSU/SUSFS)
          # Uncomment the block below to enable BBR congestion control + FQ qdisc
          # These improve network performance but are not critical for root functionality
          #
          # {
          #   echo ""
          #   echo "# OPTIONAL: Networking Enhancements"
          #   echo "CONFIG_TCP_CONG_ADVANCED=y"
          #   echo "CONFIG_TCP_CONG_BBR=y"
          #   echo "CONFIG_NET_SCH_FQ=y"
          #   echo "CONFIG_IP_NF_TARGET_TTL=y"
          #   echo "CONFIG_IP6_NF_TARGET_HL=y"
          # } >> "$DEFCONFIG"
          
          # Build Optimization (based on build type)
          if [ "${{ inputs.build_type }}" = "release" ]; then
            {
              echo ""
              echo "# Build Optimizations (Release)"
              echo "CONFIG_LTO_CLANG=y"
              echo "CONFIG_LTO_CLANG_THIN=y"
            } >> "$DEFCONFIG"
          fi
          
          echo "::endgroup::"
          echo "âœ… Kernel configuration updated"

      - name: Customize Kernel Branding
        run: |
          cd "$GITHUB_WORKSPACE/kernel"
          
          # Remove -dirty suffix
          if [ -f "scripts/setlocalversion" ]; then
            sed -i 's/-dirty//g' scripts/setlocalversion 2>/dev/null || true
          fi
          
          echo "âœ… Kernel branding customized"

      # ========================================================================
      # PHASE 5: BUILD KERNEL
      # ========================================================================

      - name: Build Kernel
        run: |
          cd "$GITHUB_WORKSPACE/kernel"
          
          # Common make arguments
          # Added ccache for faster rebuilds
          MAKE_ARGS=(
            "ARCH=${{ env.ARCH }}"
            "CROSS_COMPILE=${{ env.CROSS_COMPILE }}"
            "LLVM=1"
            "LLVM_IAS=1"
            "LD=ld.lld"
            "HOSTLD=ld.lld"
            "CC=ccache clang"
            "CXX=ccache clang++"
          )
          
          echo "::group::Generate Defconfig"
          make -j"$(nproc)" O=out "${MAKE_ARGS[@]}" "${{ env.KERNEL_DEFCONFIG }}"
          echo "::endgroup::"
          
          # Validate critical config options
          echo "::group::Validate Configuration"
          CONFIG_FILE="out/.config"
          
          if [ "${{ inputs.enable_kernelsu }}" != "false" ]; then
            if grep -q "CONFIG_KSU=y" "$CONFIG_FILE"; then
              echo "âœ… CONFIG_KSU=y verified"
            else
              echo "âš ï¸ CONFIG_KSU not found in final config"
            fi
          fi
          
          if [ "${{ inputs.enable_kernelsu }}" != "false" ] && [ "${{ inputs.enable_susfs }}" != "false" ]; then
            if grep -q "CONFIG_KSU_SUSFS=y" "$CONFIG_FILE"; then
              echo "âœ… CONFIG_KSU_SUSFS=y verified"
            else
              echo "âš ï¸ CONFIG_KSU_SUSFS not found in final config"
            fi
          fi
          echo "::endgroup::"
          
          echo "::group::Build Kernel Images"
          make -j"$(nproc)" O=out "${MAKE_ARGS[@]}" \
            KCFLAGS="-Wno-error" \
            Image Image.gz Image.lz4
          echo "::endgroup::"
          
          echo "âœ… Kernel build completed"

      # Validate critical kernel options are actually enabled
      - name: Validate Critical Kernel Options
        if: inputs.enable_kernelsu != false
        run: |
          CONFIG_FILE="$GITHUB_WORKSPACE/kernel/out/.config"
          
          echo "::group::Validating Final Kernel Configuration"
          
          # List of critical options that MUST be present
          CRITICAL_OPTIONS=(
            "CONFIG_KSU=y"
          )
          
          # Add SUSFS options if enabled
          if [ "${{ inputs.enable_susfs }}" != "false" ]; then
            CRITICAL_OPTIONS+=(
              "CONFIG_KSU_SUSFS=y"
              "CONFIG_KSU_SUSFS_SUS_PATH=y"
              "CONFIG_KSU_SUSFS_SUS_MOUNT=y"
            )
          fi
          
          MISSING_COUNT=0
          for opt in "${CRITICAL_OPTIONS[@]}"; do
            if grep -q "^${opt}$" "$CONFIG_FILE"; then
              echo "âœ… $opt"
            else
              echo "âŒ MISSING: $opt"
              MISSING_COUNT=$((MISSING_COUNT + 1))
            fi
          done
          
          echo "::endgroup::"
          
          if [ "$MISSING_COUNT" -gt 0 ]; then
            echo "âŒ $MISSING_COUNT critical option(s) missing from final .config"
            echo ""
            echo "::group::Actual values in .config (all KSU options):"
            grep "CONFIG_KSU" "$CONFIG_FILE" || echo "No KSU config found at all!"
            echo "::endgroup::"
            exit 1
          else
            echo "âœ… All critical options verified in final configuration"
          fi

      - name: Verify Build Output
        run: |
          BOOT_DIR="$GITHUB_WORKSPACE/kernel/out/arch/${{ env.ARCH }}/boot"
          
          echo "::group::Build Output Verification"
          BUILD_SUCCESS=true
          
          for img in Image Image.gz Image.lz4; do
            if [ -f "$BOOT_DIR/$img" ]; then
              size=$(stat -c%s "$BOOT_DIR/$img")
              size_mb=$((size / 1024 / 1024))
              echo "âœ… $img: ${size_mb} MB"
            else
              echo "âŒ $img: NOT FOUND"
              BUILD_SUCCESS=false
            fi
          done
          echo "::endgroup::"
          
          if [ "$BUILD_SUCCESS" = "false" ]; then
            echo "âŒ Build verification failed"
            exit 1
          fi
          
          echo "âœ… All kernel images verified"

      # ========================================================================
      # PHASE 6: GENERATE BOOT IMAGES
      # ========================================================================

      - name: Download GKI Boot Image
        run: |
          mkdir -p "$GITHUB_WORKSPACE/bootimg-work"
          cd "$GITHUB_WORKSPACE/bootimg-work"
          
          # Build GKI URL with fallback
          PRIMARY_URL="https://dl.google.com/android/gki/gki-certified-boot-android${{ env.ANDROID_VERSION }}-${{ env.KERNEL_VERSION }}-${{ env.OS_PATCH_LEVEL }}_r1.zip"
          FALLBACK_URL="https://dl.google.com/android/gki/gki-certified-boot-android${{ env.ANDROID_VERSION }}-${{ env.KERNEL_VERSION }}-2025-01_r1.zip"
          
          echo "::group::Download GKI Boot Image"
          echo "Trying: $PRIMARY_URL"
          
          if curl -sfL -o gki-boot.zip "$PRIMARY_URL" --retry 3 --retry-delay 5; then
            echo "âœ… Downloaded GKI boot image for ${{ env.OS_PATCH_LEVEL }}"
          else
            echo "âš ï¸ Primary URL failed, trying fallback..."
            if curl -sfL -o gki-boot.zip "$FALLBACK_URL" --retry 3 --retry-delay 5; then
              echo "âœ… Downloaded fallback GKI boot image (2025-01)"
            else
              echo "âŒ Failed to download GKI boot image"
              exit 1
            fi
          fi
          echo "::endgroup::"
          
          echo "::group::Unpack Boot Image"
          unzip -q gki-boot.zip
          python3 "$UNPACK_BOOTIMG" --boot_img "boot-${{ env.KERNEL_VERSION }}.img"
          echo "::endgroup::"

      - name: Build Boot Images
        run: |
          cd "$GITHUB_WORKSPACE/bootimg-work"
          BOOT_DIR="$GITHUB_WORKSPACE/kernel/out/arch/${{ env.ARCH }}/boot"
          
          # Function to build and sign boot image
          build_boot_image() {
            local kernel="$1"
            local output="$2"
            
            python3 "$MKBOOTIMG" \
              --header_version 4 \
              --kernel "$BOOT_DIR/$kernel" \
              --ramdisk out/ramdisk \
              --os_version "${{ env.ANDROID_VERSION }}.0.0" \
              --os_patch_level "${{ env.OS_PATCH_LEVEL }}" \
              --output "$output"
            
            python3 "$AVBTOOL" add_hash_footer \
              --partition_name boot \
              --partition_size $((64 * 1024 * 1024)) \
              --image "$output" \
              --algorithm SHA256_RSA2048 \
              --key "$BOOT_SIGN_KEY"
            
            local size=$(stat -c%s "$output")
            echo "âœ… Built: $output ($((size / 1024 / 1024)) MB)"
          }
          
          echo "::group::Building Signed Boot Images"
          build_boot_image "Image" "boot.img"
          build_boot_image "Image.gz" "boot-gz.img"
          build_boot_image "Image.lz4" "boot-lz4.img"
          echo "::endgroup::"

      # ========================================================================
      # PHASE 7: PREPARE ARTIFACTS
      # ========================================================================

      - name: Set Artifact Names
        run: |
          # Build comprehensive artifact name
          KSU_PART=""
          SUSFS_PART=""
          
          if [ "${{ inputs.enable_kernelsu }}" != "false" ]; then
            KSU_PART="-Wild_KSU-${{ env.KSU_VERSION }}"
          fi
          
          if [ "${{ inputs.enable_kernelsu }}" != "false" ] && [ "${{ inputs.enable_susfs }}" != "false" ]; then
            SUSFS_PART="-SUSFS"
          fi
          
          ARTIFACT_BASE="${{ env.DEVICE_NAME }}${KSU_PART}${SUSFS_PART}-android${{ env.ANDROID_VERSION }}-${{ env.KERNEL_FULL_VERSION }}-${{ env.OS_PATCH_LEVEL }}"
          
          echo "ARTIFACT_BASE=$ARTIFACT_BASE" >> "$GITHUB_ENV"
          echo "ðŸ“¦ Artifact name: $ARTIFACT_BASE"

      - name: Prepare AnyKernel3 Package
        run: |
          BOOT_DIR="$GITHUB_WORKSPACE/kernel/out/arch/${{ env.ARCH }}/boot"
          AK3_DIR="$GITHUB_WORKSPACE/AnyKernel3"
          
          # Copy kernel image
          cp "$BOOT_DIR/Image" "$AK3_DIR/"
          
          # Create device-specific anykernel.sh using echo to avoid YAML issues
          {
            echo '# AnyKernel3 Ramdisk Mod Script'
            echo '# osm0sis @ xda-developers'
            echo ''
            echo '## AnyKernel setup'
            echo "properties() { '"
            echo 'kernel.string=Nothing Phone 2 Kernel with Wild_KSU + SUSFS'
            echo 'do.devicecheck=1'
            echo 'do.modules=0'
            echo 'do.systemless=1'
            echo 'do.cleanup=1'
            echo 'do.cleanuponabort=0'
            echo 'device.name1=Pong'
            echo 'device.name2=pong'
            echo 'supported.versions=12-15'
            echo 'supported.patchlevels='
            echo "'; }"
            echo ''
            echo '# Shell variables'
            echo 'block=/dev/block/bootdevice/by-name/boot;'
            echo 'is_slot_device=1;'
            echo 'ramdisk_compression=auto;'
            echo 'patch_vbmeta_flag=auto;'
            echo ''
            echo '## AnyKernel methods'
            echo '. tools/ak3-core.sh;'
            echo ''
            echo '## AnyKernel boot install'
            echo 'split_boot;'
            echo 'flash_boot;'
            echo '## end boot install'
          } > "$AK3_DIR/anykernel.sh"
          
          echo "âœ… AnyKernel3 package prepared"

      - name: Create Output Directory
        run: |
          mkdir -p "$GITHUB_WORKSPACE/output"
          
          # Copy boot images
          cp "$GITHUB_WORKSPACE/bootimg-work/boot.img" "$GITHUB_WORKSPACE/output/${{ env.ARTIFACT_BASE }}-boot.img"
          cp "$GITHUB_WORKSPACE/bootimg-work/boot-gz.img" "$GITHUB_WORKSPACE/output/${{ env.ARTIFACT_BASE }}-boot-gz.img"
          cp "$GITHUB_WORKSPACE/bootimg-work/boot-lz4.img" "$GITHUB_WORKSPACE/output/${{ env.ARTIFACT_BASE }}-boot-lz4.img"
          
          # Copy raw kernel images
          BOOT_DIR="$GITHUB_WORKSPACE/kernel/out/arch/${{ env.ARCH }}/boot"
          cp "$BOOT_DIR/Image" "$GITHUB_WORKSPACE/output/"
          cp "$BOOT_DIR/Image.gz" "$GITHUB_WORKSPACE/output/"
          cp "$BOOT_DIR/Image.lz4" "$GITHUB_WORKSPACE/output/"
          
          # Create build info file using echo to avoid YAML heredoc issues
          {
            echo "# Nothing Phone 2 Kernel Build Information"
            echo "# Generated: ${{ env.BUILD_TIMESTAMP }}"
            echo ""
            echo "## Device"
            echo "Device: ${{ env.DEVICE_NAME }}"
            echo "Codename: ${{ env.DEVICE_CODENAME }}"
            echo "Platform: ${{ env.DEVICE_PLATFORM }}"
            echo ""
            echo "## Kernel"
            echo "Version: ${{ env.KERNEL_FULL_VERSION }}"
            echo "Branch: ${{ env.KERNEL_BRANCH }}"
            echo "Android: ${{ env.ANDROID_VERSION }}"
            echo "Security Patch: ${{ env.OS_PATCH_LEVEL }}"
            echo ""
            echo "## Components"
            echo "Wild_KSU: ${{ env.KSU_VERSION }} (${{ env.KSU_COMMIT }})"
            echo "SUSFS: ${{ env.SUSFS_VERSION }} (${{ env.SUSFS_COMMIT }})"
            echo ""
            echo "## Build"
            echo "Type: ${{ env.BUILD_TYPE }}"
            echo "Date: ${{ env.BUILD_DATE }}"
            echo "Workflow Run: ${{ github.run_id }}"
            echo ""
            echo "## Sources"
            echo "Kernel: ${{ env.KERNEL_REPO }}"
            echo "Wild_KSU: ${{ env.WILD_KSU_REPO_URL }}"
            echo "SUSFS: ${{ env.SUSFS_REPO }}"
          } > "$GITHUB_WORKSPACE/output/build-info.txt"
          
          echo "âœ… Output directory prepared"

      # ========================================================================
      # PHASE 8: UPLOAD ARTIFACTS
      # ========================================================================

      - name: Upload AnyKernel3
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.ARTIFACT_BASE }}-AnyKernel3
          path: AnyKernel3/
          compression-level: 9

      - name: Upload Boot Images
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.ARTIFACT_BASE }}-boot-images
          path: |
            output/*-boot.img
            output/*-boot-gz.img
            output/*-boot-lz4.img
          compression-level: 9

      - name: Upload Kernel Images
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.ARTIFACT_BASE }}-kernel-images
          path: |
            output/Image
            output/Image.gz
            output/Image.lz4
          compression-level: 9

      - name: Upload Build Info
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.ARTIFACT_BASE }}-build-info
          path: output/build-info.txt

      - name: Upload Patch Rejects
        if: always() && env.REJ_COUNT != '0'
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.ARTIFACT_BASE }}-patch-rejects
          path: patch-rejects/
          compression-level: 9

      # ========================================================================
      # PHASE 9: BUILD SUMMARY
      # ========================================================================

      - name: Generate Build Summary
        if: always()
        run: |
          # Determine status emoji
          if [ "${{ job.status }}" = "success" ]; then
            STATUS_EMOJI="âœ…"
            STATUS_TEXT="Successful"
          else
            STATUS_EMOJI="âŒ"
            STATUS_TEXT="Failed"
          fi
          
          # Build summary using echo to avoid YAML heredoc issues
          {
            echo "# $STATUS_EMOJI Kernel Build $STATUS_TEXT"
            echo ""
            echo "## ðŸ“± Device Information"
            echo "| Property | Value |"
            echo "|----------|-------|"
            echo "| **Device** | ${{ env.DEVICE_NAME }} |"
            echo "| **Codename** | ${{ env.DEVICE_CODENAME }} |"
            echo "| **Platform** | ${{ env.DEVICE_PLATFORM }} |"
            echo ""
            echo "## ðŸ§ Kernel Information"
            echo "| Property | Value |"
            echo "|----------|-------|"
            echo "| **Version** | ${{ env.KERNEL_FULL_VERSION }} |"
            echo "| **Branch** | ${{ env.KERNEL_BRANCH }} |"
            echo "| **Android** | ${{ env.ANDROID_VERSION }} |"
            echo "| **Security Patch** | ${{ env.OS_PATCH_LEVEL }} |"
            echo ""
            echo "## ðŸ”§ Components"
            echo "| Component | Version | Commit | Status |"
            echo "|-----------|---------|--------|--------|"
            echo "| **Wild_KSU** | ${{ env.KSU_VERSION }} | \`${{ env.KSU_COMMIT }}\` | ${{ inputs.enable_kernelsu != false && 'âœ… Enabled' || 'â¸ï¸ Disabled' }} |"
            echo "| **SUSFS** | ${{ env.SUSFS_VERSION }} | \`${{ env.SUSFS_COMMIT }}\` | ${{ inputs.enable_susfs != false && inputs.enable_kernelsu != false && 'âœ… Enabled' || 'â¸ï¸ Disabled' }} |"
            echo ""
            echo "## âš™ï¸ Build Configuration"
            echo "| Setting | Value |"
            echo "|---------|-------|"
            echo "| **Build Type** | ${{ env.BUILD_TYPE }} |"
            echo "| **Build Date** | ${{ env.BUILD_DATE }} |"
            echo "| **Patch Rejects** | ${{ env.REJ_COUNT }} |"
            echo ""
            echo "## ðŸ“¦ Artifacts"
            echo "| Artifact | Description |"
            echo "|----------|-------------|"
            echo "| **AnyKernel3** | Flashable zip for custom recovery (TWRP, OrangeFox) |"
            echo "| **boot.img** | Signed boot image (raw kernel) |"
            echo "| **boot-gz.img** | Signed boot image (gzip compressed) |"
            echo "| **boot-lz4.img** | Signed boot image (lz4 compressed) |"
            echo "| **Kernel Images** | Raw Image, Image.gz, Image.lz4 |"
            echo "| **Build Info** | Complete build metadata |"
            echo ""
            echo "## ðŸ”— Source Repositories"
            echo "- [Kernel Source](${{ env.KERNEL_REPO }})"
            echo "- [Wild_KSU](${{ env.WILD_KSU_REPO_URL }})"
            echo "- [SUSFS](${{ env.SUSFS_REPO }})"
            echo ""
            echo "---"
            echo "*Build completed at ${{ env.BUILD_TIMESTAMP }}*"
            echo "*Workflow run: [${{ github.run_id }}](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})*"
          } >> "$GITHUB_STEP_SUMMARY"
          
          echo "âœ… Build summary generated"
